%----------------------------------------------------------------------------------------
%	MODELLO
%----------------------------------------------------------------------------------------

\section*{Il modello}
\addcontentsline{toc}{section}{\protect\numberline{}Il modello}%
\label{sec:modello}

Nel Capitolo~\ref{sec:entita_coinvolte} sono state individuate ed analizzate le entita' che caratterizzano il sistema. La fase successiva, su cui questo capitolo si focalizza, consiste nel definire le interazioni che legano le suddette entita', in maniera tale da poter derivare un modello per il sistema.

\subsection*{Interazione tra giocatori: il controllore}
\addcontentsline{toc}{subsection}{\protect\numberline{}Interazione tra giocatori: il controllore}%
\label{sec:modello_interazione_giocatori}

%Interazione tra giocatori: il controllore.
I giocatori sono i principali attori del sistema. Un giocatore si sposta dentro e fuori dal campo, e' in grado di compiere diversi tipi di azioni (Sezione~\ref{sec:entita_giocatori}), che decide sia sulla base del proprio stato che dello stato della propria squadra e della partita. Un aspetto fondamentale vede i giocatori, cosi' come avviene nel mondo reale, operare in maniera parallela e concorrente tra di loro: questo implica che i risultati delle loro azioni debbano riflettersi sullo stato di gioco, che come descritto in Sezione~\ref{sec:entita_stato}, detiene tutte le informazioni che definiscono la partita in un dato istante. Si pone pero' un problema: i giocatori, per poter conoscere le informazioni che permetteranno loro di decidere la prossima azione da compiere, i giocatori devono accedere allo stato, che tuttavia e' unico. E' dunque necessario regolamentare l'accesso a tale risorsa, in maniera tale da preservarne la consistenza e la correttezza.\\

L'organo che si occupa di permettere l'interazione tra diversi giocatori e' il \textit{controllore}. In quanto entita' centrale di controllo, i suoi molteplici compiti possono essere raggruppati come segue:

\begin{enumerate}
	\item Permettere ai giocatori di accedere allo stato, sia per leggerne le informazioni sia per poterle modificare
	\item Sequenzializzare gli accessi allo stato da parte dei giocatori, al fine di non creare inconsistenze sulle informazioni in esso contenute
	\item Ricoprire il ruolo di arbitro di gioco ``onnisciente'' (verra' dettagliato in Sezione~\ref{sec:modello_verifica_arbitro})
\end{enumerate}

Come gia' accennato precedentemente, un giocatore decide la sua prossima mossa sulla base dello stato corrente della partita: ad esempio, trovandosi in possesso della palla nell'area avversaria e senza nessun giocatore a marcarlo, e' ragionevole che il giocatore decida di tirare per provare a realizzare un goal. Al tempo stesso, l'azione che egli compie si ripercuote sullo stato della partita, andandone a modificare una parte: di nuovo, se il giocatore segna, il punteggio della partita cambia e i giocatori ritornano in posizione di partenza per ricominciare il gioco. Questo meccanismo mette in luce una necessita' tale per cui le operazioni che alterano lo stato siano quanto piu' possibile sequenziali ed atomiche. Sebbene questo argomento verra' trattato ampiamente nel Capitolo~\ref{sec:analisi_architetturale}, e' importante capire il motivo dell'importanza di queste due caratteristiche.\\

L'assunzione di atomicita' si rivela particolamente critica quando si assume di operare in condizioni di prerilascio dei processi. Sotto questa condizione, un processo correntemente in esecuzione puo' essere ``temporaneamente fermato'' (prerilasciato) in favore di un altro processo, che entra quindi in esecuzione al suo posto; una simile condizione si verifica, ad esempio, se il processo corrente ha una priorita' inferiore di quello che vuole subentrare. Per spiegare come il prerilascio minacci la consistenza dello stato della partita, si consideri una situazione dove due giocatori avversari si contendono il possesso della palla, che giace inerte in mezzo a loro. Entrambi i giocatori leggono lo stato e avviano il processo di decisione della prossima azione. Tuttavia, il processo relativo al primo giocatore viene prerilasciato. Nel frattempo, il secondo giocatore conquista la palla e si muove verso la porta avversaria. Quando il primo giocatore torna in esecuzione si trova in uno stato inconsistente, in quanto lo stato e' cambiato senza che lui lo sappia. Ancora peggio, se il primo giocatore procede con la scrittura della sua azione, lo stato verra' modificato erroneamente, potenzialmente togliendo il possesso di palla al secondo giocatore.\\

Arrivati a questo punto, serve quindi definire come i giocatori vanno effettivamente a modificare lo stato di gioco. Il modello prevede che sia solamente il controllore ad effetuare le scritture vere e proprie sulla base delle azioni decise e sottoposte da parte dei giocatori. Tali richieste vengono valutate in modo sequenziale, andando cosi’ a modificare lo stato con una azione alla volta evitando cosi’ condizioni di inconsistenza sullo stato.\\

Come detto in precedenza, all’inizio di ogni suo turno un giocatore deve prendere coscienza di quale sia lo stato attuale di gioco, decidere la prossima mossa sulla base di quest’ultimo e sottoporla al controllore per modificare lo stato. Questo meccanismo, abbinato al fatto che i giocatore eseguono in modo potenzialmente parallelo e che ogni richiesta viene elaborata in maniera sequenziale, farebbe pensare ad una soluzione che prevede un accesso esclusivo al controllore da parte di un giocatore per tutta la durata del suo ciclo di esecuzione. L’idea alla base della soluzione e’ quindi quella di scomporre la routine del turno come segue:\\

\begin{enumerate}
	\item il giocatore richiede al controllore lo stato di gioco
	\item viene effettuata una fase di computazione con la quale decide la prossima mossa
	\item richiede al controllore di applicare l’azione scelta allo stato.
\end{enumerate}

Si ha quindi che la fase di lettura e la fase di scrittura (primo e terzo punto) vengono effettuate “online”, ovvero tramite accesso esclusivo al controllore; la parte di scelta della prossima azione avviene invece “offline”, quindi senza la necessita’ di interagire con esso. In questo modo si guadagna un parallelismo potenziale nella seconda fase, permettendo cosi’ ai giocatori di non interferire tra di loro nella decisione della prossima mossa.

\subsection*{Verifica sullo stato di gioco: l'arbitro}
\addcontentsline{toc}{subsection}{\protect\numberline{}Verifica sullo stato di gioco: l'arbitro}%
\label{sec:modello_verifica_arbitro}

Affiche' una partita si svolga secondo le regole e le modalita' stabilite dal gioco del calcio c'e' bisogno di un arbitro che regoli l'andamento del gioco. Le mansioni dell'arbitro sono molteplici:

\begin{itemize}
	\item Sancire l'inizio e la fine dei tempi di gioco (inizio primo tempo - fine primo tempo - inizio secondo tempo - fine partita)
	\item Fermare il gioco e farlo riprendere a seguito (e.g. una rimessa laterale)
	\item Segnalare eventuali irregolarita' da parte dei giocatori (e.g. un fallo)
	\item Tenere il conto dei gol segnati da entrambe le squadre, cosi' da decretare il vincitore alla fine della partita
	\item Gestire le richieste di sostituzione e di cambio di formazione da parte degli allenatori
\end{itemize}

L'arbitro deve quindi essere in grado di controllare tutte le mosse dei giocatori, cosi' come lo stato e la posizione della palla e la durata della partita fino a quel momento. Nella realta', il ruolo dell'arbitro e' assegnato ad un essere umano, che quindi non e' infallibile: si pensi ad esempio ad un fallo che viene commesso irregolarmente alle sue spalle mentre lui e' impegnato ad assegnare un calcio d'angolo. In questa simulazione si assume piu' semplicemente che l'arbitro sia ``onnisciente'', ovvero abbia la facolta' di analizzare ogni singola mossa di ciascun giocatore e della palla, in maniera da poter segnalare immediatamente ogni irregolarita' oppure fermare il gioco all'occorrenza.\\

Si ha cosi' che il controllore, descritto nel paragrafo precedente, ricopre anche il ruolo di arbitro. Questa decisione ha delle ripercussioni non solo nello svolgersi del gioco (l'arbitro e' onnisciente), ma anche nell'assegnazione delle risorse di calcolo. Infatti, se l'arbitro fosse soggetto agli stessi vincoli di esecuzione dei giocatori, andrebbe a concorrere assieme a loro per l'esecuzione sulla CPU come task a se stante; questa situazione non si verifica invece nel caso in cui sia il controllore ad essere anche arbitro, essendo l'entita' centrale che si occupa di eseguire a tutti gli effetti le mosse dei giocatori. Maggiori dettagli sull'implementazione dell'arbitro verranno esposti in Sezione~\ref{sec:implemetazione_concorrenza}.\\

L'elenco delle funzioni che l'arbitro deve espletare nasconde tuttavia un punto critico su cui e' opportuno soffermarsi. I primi quattro punti sono strettamente legati alla componente concorrente della simulazione, ovvero quella che vede l'interazione dei giocatori con il controllore e, in alcuni casi, l'agente di movimento. L'ultimo punto fa invece riferimento alla componente distribuita della simulazione, ovvero quella che si occupa di ricevere e gestire i comandi impartiti dagli allenatori ed eventualmente dalla finestra principale di controllo (che, come verra' esposto successivamente, coincide con la componente che mostra il campo di gioco e lo svolgersi della partita). La differenza sostanziale tra queste due tipologie di eventi e' racchiusa nel fatto che gli eventi provenienti dalla componente distribuita non sono deterministici e non seguono nessuna regola di generazione, a differenza degli eventi relativi alla parte concorrente.
La presenza di due sorgenti di eventi introduce un problema significativo, ovvero l'ordine in cui l'arbitro deve processare/consumare quegli eventi. Ad esempio, si consideri una situazione dove si ha una richiesta di sostituzione per il giocatore 1 in favore del giocatore 3 e, allo stesso tempo, sia stato commesso un fallo commesso dal giocatore 1 sul giocatore 2. L'ordine in cui vengono processati questi eventi determina lo stato successivo, che diverge a seconda che si consideri prima uno oppure prima l'altro. Bisogna tenere conto, ad ogni modo, che gli eventi che vengono generati dalla componente distribuita hanno come precondizione il gioco fermo: quindi c'e' una stretta dipendenza unidirezionale tra un evento singolo della componente concorrente e gli eventi della componente distribuita. L'approccio da seguire per garantire il massimo livello di correttezza temporale e' quindi il seguente: l'arbitro dovra' prima processare l'evento singolo della componente concorrente (che puo' causare il gioco fermo, nel caso non lo fosse gia') e solo poi processare gli eventi della componente distribuita, se le condizioni sono opportune.

\subsection*{La palla in movimento: l'entita' e l'agente di movimento}
\addcontentsline{toc}{subsection}{\protect\numberline{}La palla in movimento: l'entita' e l'agente di movimento}%
\label{sec:modello_palla_agente_movimento}

%La palla in movimento: l'entita' e l'agente di movimento.

La palla e' una parte fondamentale del modello della simulazione, in quanto il suo possesso viene conteso dai giocatori che devono tirarla in porta, segnando un gol per la loro squadra.

% DA SPOSTARE NEL CAPITOLO PRECEDENTE
%Il suo comportamento puo' essere definito come una macchina a stati, schematizzato nel seguente diagramma:\\
%\begin{center}
%	\includegraphics[scale=.5]{images/ball_state_diagram}
%\end{center}

In ogni momento della partita, la palla occupa una delle celle del campo. Nel caso sia posseduta da un giocatore, essi condividono la stessa cella; in caso contrario, la palla occupa la cella in cui si trova. Inoltre, la palla puo' trovarsi solamente in due stati: inerzia e moto. Una palla in movimento si puo' avere quando il giocatore che la controlla si sposta con essa; inoltre, si ha una palla in movimento anche quando un giocatore la passa verso un altro giocatore oppure effettua un tiro verso la porta avversaria. Al contrario, una palla e' inerte se non e' controllata da nessun giocatore, solitamente quando un passaggio o un tiro mancano il bersaglio (e.g. un passaggio troppo debole).\\

Ad ogni modo, la palla e' un'entita' passiva, che non compie azioni proprie ma che subisce azioni di altre entita' attive (i giocatori). Di conseguenza, quando un giocatore effettua un passaggio oppure un tiro, la palla deve essere spostata da un'entita' che pero' non puo' essere il giocatore stesso: in altre parole, si tratta di simulare l'impressione di un moto alla palla a seguito di un'azione del giocatore che la controlla. Questa mansione e' ricoperta dal cosiddetto \textit{agente di movimento}. L'agente di movimento e' un'entita' concorrente agli altri giocatori, il cui unico compito e' quello di spostare la palla in una determinata direzione fino a che la potenza ad essa impressa e' sufficiente a farla avanzare alla cella successiva. Una volta completato il suo compito, smette di eseguire in attesa del prossimo spostamento da effettuare. In alcuni casi, l'agente di movimento viene volutamente bloccato attraverso l'arbitro, ad esempio nel caso in cui la palla esca dal campo e sia necessario assegnare una rimessa oppure un calcio d'angolo.

\subsection*{Modifiche sulle squadre: gli allenatori}
\addcontentsline{toc}{subsection}{\protect\numberline{}Modifiche sulle squadre: gli allenatori}%
\label{sec:modello_squadre_allenatori}

%Modifiche sulle squadre: gli allenatori.

Nel gioco del calcio i giocatori di ciascuna squadra vengono coordinati dal proprio allenatore, che ha il compito di scegliere come disporre i giocatori in campo (la formazione) e di effettuare delle sostituzioni, come conseguenza di un infortunio o piu' semplicemente per una scelta tattica. In questa simulazione i due allenatori rappresentano due componenti distribuite separate, che comunicano con l'unita' centrale di controllo. Ciascun allenatore ha la facolta' di prendere le seguenti decisioni:

\begin{itemize}
	\item effettuare un cambio di formazione per la propria squadra
	\item effettuare una sostituzione di un giocatore con un suo compagno presente in panchina
\end{itemize}

Le decisioni prese da un allenatore hanno come precondizione necessaria il gioco fermo: sara' pertanto l'arbitro a dover esaminare e successivamente accettare le richieste di un allenatore solo quando le condizioni lo permettono. Nel caso di un semplice cambio di formazione, la decisione dell'allenatore viene applicata sulla squadra, cosicche' i giocatori al proprio turno successivo sappiano che la loro posizione di riferimento e' cambiata. Diverso e piu' complesso e' invece il caso della sostituzione. La sequenza di operazioni che seguono una richiesta di sostituzione si possono schematizzare come segue:

\begin{enumerate}
	\item L'arbitro riceve la richiesta di sostituzione e, non appena il gioco e' fermo, procede a notificarlo ai giocatori
	\item Ciascun giocatore, prima di decidere la propria mossa, controlla se l'allenatore ha deciso di sostituirlo con un compagno
	\item Nel caso del giocatore interessato alla sostituzione, esso si dirige verso la panchina (eventualmente lasciando la palla dove si trova)
	\item Una volta giunto in panchina, il suo compagno prende il suo posto in campo e si dirige verso la propria posizione di riferimento
	\item L'arbitro, ad ogni turno, controlla se il giocatore entrante ha raggiunto la posizione di riferimento e, in quel caso, sancisce la ripresa del gioco
\end{enumerate}

Il comportamento sopra descritto vale anche nel caso di piu' sostituzioni simultanee, che vedono i giocatori uscire ed entrare nel campo allo stesso tempo.\\

Ciascun allenatore ha inoltre una visione meno precisa del gioco e riceve pertanto un sottoinsieme degli eventi che caratterizzano una partita: dal punto di vista decisionale e' infatti poco interessante per un allenatore conoscere ogni singolo movimento di ogni giocatore. Si ha quindi che l'allenatore viene notificato solo in caso di eventi ``salienti'', che come descritto nel Capitolo~\ref{sec:analisi_architetturale}, sono stati denominati \textit{Game Events}.

\subsection*{Gestione delle fasi di gioco: entita' di gioco}
\addcontentsline{toc}{subsection}{\protect\numberline{}Gestione delle fasi di gioco: entita' di gioco}%
\label{sec:modello_fasi_game_entity}

%Gestione delle fasi di gioco: entita' di gioco.

[secondo me non va messa qui, e' prettamente implementativa]
